@model List<BusinessFinancialAccounting.Models.Product>
@{
    ViewData["Title"] = "Пункт продажу";
    var qty = (IDictionary<int, decimal>)ViewBag.Qty ?? new Dictionary<int, decimal>();
    decimal total = ViewBag.Total ?? 0m;
    decimal line;
}

<div class="container mt-3">
    <h2>Пункт продажу</h2>

    @if (TempData["AlertMsg"] != null)
    {
        <div class="alert alert-@TempData["AlertType"]">@TempData["AlertMsg"]</div>
    }

    <!-- Форма добавления по коду -->
    <form method="post" asp-action="AddByCode" class="row g-2 mt-3">
        <div class="col-auto"><label for="code" class="col-form-label">Код</label></div>
        <div class="col-auto"><input id="code" name="code" class="form-control" type="number" required /></div>
        <div class="col-auto"><button class="btn btn-primary" type="submit">Додати</button></div>
    </form>

    <!-- Отдельная форма очистки (НЕ внутри предыдущей) -->
    <form method="post" asp-action="Clear" class="mt-2">
        <button class="btn btn-outline-secondary" type="submit">Очистити</button>
    </form>

    <table class="table table-bordered align-middle mt-3">
        <thead>
            <tr>
                <th style="width:10%">код</th>
                <th>назва</th>
                <th style="width:15%">кількість</th>
                <th style="width:12%">одиниці вимірювання</th>
                <th style="width:15%">ціна за одну одиницю</th>
                <th style="width:15%">сума</th>
                <th style="width:6%"></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var p in Model)
            {
                var q = qty.TryGetValue(p.Id, out var v) ? v : 0m;
                line = Math.Round(p.Price * q, 2);
                <tr>
                    <td>@p.Code</td>
                    <td>@p.Name</td>
                    <td>
                        <form method="post" asp-action="ChangeQty">
                            <input type="hidden" name="productId" value="@p.Id" />
                            <input type="number" name="qty" value="@q" min="0" step="1"
                                   class="form-control"
                                   onchange="this.form.submit()" />
                        </form>
                    </td>
                    <td>@p.Units</td>
                    <td>@p.Price.ToString("0.00")</td>
                    <td>@line.ToString("0.00")</td>
                    <td>
                        <form method="post" asp-action="Remove">
                            <input type="hidden" name="productId" value="@p.Id" />
                            <button class="btn btn-sm btn-outline-danger">×</button>
                        </form>
                    </td>
                </tr>
            }
        </tbody>
        <tfoot>
            <tr>
                <th colspan="5" class="text-end">Загалом</th>
                <th>@total.ToString("0.00")</th>
                <th></th>
            </tr>
        </tfoot>
    </table>

    <div class="d-flex gap-2 mt-3">
        <form method="post" asp-action="Pay" asp-route-method="cash">
            <button class="btn btn-success">Оплатити готівкою</button>
        </form>
        <form method="post" asp-action="Pay" asp-route-method="card">
            <button class="btn btn-info">Оплатити карткою</button>
        </form>
    </div>
</div>
